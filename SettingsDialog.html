<!DOCTYPE html>
<html>

<head>
	<base target="_top">
	<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
	<!-- The CSS package above applies Google styling to buttons and other elements. -->

	<style>
		.col-contain {
			overflow: hidden;
		}

		.col-one {
			float: left;
			width: 50%;
		}
	</style>
</head>

<script>
	function saveSettings() {

    let accountingCurrency = document.getElementById('accounting-currency').value;
    let fiats = document.getElementById('fiats').value;
    let cryptos = document.getElementById('cryptos').value;
    let defaultLotMatching = document.getElementById('default-lot-matching').value;

    let apiProvider = document.getElementById('api-provider-cc').checked ? 
      'CryptoCompare' : 
      document.getElementById('api-provider-cmc').checked ?
      'CoinMarketCap' : 
      null;
    
    let apiKey = document.getElementById('api-key').value;

    let settings = {
      accountingCurrency: accountingCurrency,
      fiats: fiats,
      cryptos: cryptos,
      defaultLotMatching: defaultLotMatching,
      apiProvider: apiProvider,
      apiKey: apiKey
    }

    google.script.run
    .withSuccessHandler(onSuccess)
    .withFailureHandler(onFailure)
    .saveSettings(settings);
  
 }

 function onSuccess() {

   google.script.host.close();

 }

 function onFailure(error) {

    let div = document.getElementById('output');
     div.innerHTML = error.message;
 } 

</script>

<? 
let userProperties = PropertiesService.getUserProperties();
let accountingCurrency = userProperties.getProperty('accountingCurrency');
let defaultLotMatching = userProperties.getProperty('defaultLotMatching');
let lotMatchings = CryptoTracker.lotMatchings;
let apiProvider = userProperties.getProperty('apiProvider');
let apiKey = userProperties.getProperty('apiKey');

let fiatList = userProperties.getProperty('fiats');
let fiats = [];
if(fiatList) {
  fiats = fiatList.split(',');
}

let cryptoList = userProperties.getProperty('cryptos');
let cryptos = [];
if(cryptoList) {
  cryptos = cryptoList.split(',');
}

?>

<body>
	<div>
		<form id="settingsForm">
			<div class="block col-contain">
				<div class="col-one">
					<div class="block form-group">
						<label for="accounting-currency">Accounting Currency</label>
					  <select id="accounting-currency">
              <? for(let fiat of fiats) {?>
              <option <? if(fiat == accountingCurrency) {?>selected<?} ?>><?= fiat ?></option>
              <?}?>
              </select>
					</div>
					<div class="block form-group">
						<label for="fiats">Fiat Tickers</label>
						<textarea id="fiats" rows="3"><?=fiatList?></textarea>
					</div>
				</div>
				<div>
					<div class="block form-group">
						<label for="default-lot-matching">Default Lot Matching</label>
						<select id="default-lot-matching">
              <? for(let lotMatching of lotMatchings) {?>
              <option <? if(lotMatching == defaultLotMatching) {?>selected<?} ?>><?=lotMatching?></option>
              <?}?>
            </select>
					</div>
					<div class="block form-group">
						<label for="cryptos">Crypto Tickers</label>
						<textarea id="cryptos" rows="3"><?=cryptoList?></textarea>
					</div>
				</div>
			</div>
			<div class="block form-group">
				<div>
					<input type="radio" name="api-provider" id="api-provider-cc" value="cc" <? if(apiProvider == 'CryptoCompare') {?>checked
					<?} ?>>
					<label for="api-provider-cc">CryptoCompare API key</label>
				</div>
				<div>
					<input type="radio" name="api-provider" id="api-provider-cmc" value="cmc" <? if(apiProvider == 'CoinMarketCap') {?>checked
					<?} ?>>
					<label for="api-provider-cmc">CoinMarketCap API key</label>
				</div>
				<input type="text" id="api-key" style="width: 460px;" value="<?=apiKey?>" placeholder="< -- paste API key here -- >">
			</div>
				<div class="block form-group">
					<input type="button" class="action" value="Save" onclick="saveSettings();" />
					<input type="button" value="Cancel" onclick="google.script.host.close();" />
				</div>
		</form>
		<div id="output"></div>
	</div>
</body>

</html>